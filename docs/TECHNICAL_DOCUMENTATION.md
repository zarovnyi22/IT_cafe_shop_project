# Технічна документація кавової POS системи

## 1. Огляд рішення
- **Призначення:** облік продажів, залишків інгредієнтів і ролей *Barista* / *Admin* для невеликої кав'ярні.
- **Стек:** Node.js + Express + Sequelize (SQLite), фронтенд на React (Vite). Сервер віддає API і готовий фронтенд-білд.
- **Аутентифікація:** JWT (12 годин), авторизація за ролями через middleware.
- **Сумісність зі схемою завдання:** моделі повторюють таблиці з `coffee_shop_db.sql` (categories, employees, ingredients, products, recipes, supplies, orders, order_details).

## 2. Структура репозиторію
- `server.js` — конфігурація Express, маршрути, бізнес-логіка замовлень, інвентаризації, звітів.
- `server/` — підключення до БД (`db.js`), моделі Sequelize (`models.js`), токени (`auth.js`), первинне наповнення (`seed.js`).
- `frontend/` — застосунок Vite/React (включно зі збіркою в `frontend/dist` якщо виконано build).
- `coffee_shop_db.sql` — вихідна SQL-схема з методичних вказівок.
- `docs/TECHNICAL_DOCUMENTATION.md` — цей файл.
- `Методичні_вказівки_до_проєкту_it.txt` — вихідні вимоги.

## 3. Запуск проєкту локально
1. **Встановити залежності бекенду:** `npm install` (в офлайн-середовищах може знадобитися локальний кеш).
2. **Встановити залежності фронтенду:** `npm install --prefix frontend`.
3. **Підняти API:** `npm start` (автосинхронізація схеми й сидування БД відбуваються при старті).
4. **Підняти фронтенд у dev-режимі:** `npm run dev --prefix frontend` → http://localhost:5173.
5. **Продакшн-сервер:** зібрати фронтенд `npm run build --prefix frontend`, покласти білд у `frontend/dist` (Express автоматично віддає статику), запустити `npm start`.

### Додаткові команди
- **Повторне сидування / скидання БД:** `npm run seed` (drop + create всі таблиці й наново заповнити демон-даними).
- **Dev-режим зі спостереженням:** `npm run dev` (nodemon).

## 4. Налаштування середовища
- **Node.js:** 18+.
- **ENV:** `APP_SECRET` (секрет для JWT, за замовчуванням `super-secret-key`), `PORT` (стандартно `8000`).
- **База:** SQLite файл `data/coffee_shop.sqlite`. Створюється автоматично; достатньо прав на запис каталогу `data/`.

## 5. База даних і початкові дані
- **Моделі:**
  - Category ↔ Product (1:N)
  - Ingredient ↔ Recipe (1:N), Product ↔ Recipe (1:N)
  - Ingredient ↔ Supply (1:N)
  - Employee ↔ Order (1:N); Order ↔ OrderDetail (1:N); Product ↔ OrderDetail (1:N)
- **Схема:** поля та типи відповідають SQL з методички (ENUM, DECIMAL(10,2), PK/FK), додатково у `orders` поле `completed_at`.
- **Сидування (`server/seed.js`):**
  - 4 категорії (кава, чаї, десерти, випічка).
  - 10 інгредієнтів з порогами запасів.
  - 3 співробітники з паролями (`admin123`, `barista123`).
  - 8 продуктів меню.
  - Рецептури для кожного продукту (зв'язок продукт → інгредієнт + кількість).
  - Поставки, що поповнюють запаси (Supply).
  - 3 історичні замовлення з деталями та одним завершеним (`status: Completed`).
- **Оновлення схеми:** при старті виконується `sequelize.sync({ alter: true })`; якщо таблиць або співробітників немає — виконується повне seed-заповнення.

## 6. Сервер та API
### Вхідні точки
- `POST /api/login` — приймає `{ phone, password }`, повертає JWT і базові дані співробітника. Блокує неактивні акаунти.
- `GET /api/me` — повертає поточного користувача (з токеном).

### Меню та категорії
- `GET /api/categories` — список категорій (усі ролі).
- `POST /api/categories` — створити категорію (Admin).
- `GET /api/products?all=true` — товари; для Admin опційно включає неактивні.
- `POST /api/products` — створення товару (Admin).
- `PUT /api/products/:id` — оновлення атрибутів / активація-деактивація (Admin).
- `DELETE /api/products/:id` — м'яка деактивація товару (Admin).

### Інгредієнти та склад
- `GET /api/ingredients` — залишки з ознакою `low` (усі ролі).
- `POST /api/ingredients` — створення інгредієнта (Admin).
- `PUT /api/ingredients/:id` — редагування назви/одиниць/порогу/залишку (Admin).
- `POST /api/ingredients/:id/inventory` — інвентаризація: фіксує фактичний залишок, записує дельту в Supply (Admin).
- `POST /api/ingredients/:id/writeoff` — службове списання запасу, додає негативну поставку (Admin).

### Рецепти
- `GET /api/products/:id/recipes` — читання рецептури продукту (Admin).
- `PUT /api/products/:id/recipes` — повна заміна рецептури (Admin), валідує наявність інгредієнтів і кількість > 0.

### Облікові записи співробітників
- `GET /api/employees` — список акаунтів (Admin).
- `POST /api/employees` — створити співробітника (Admin), унікальність телефону перевіряється.
- `PATCH /api/employees/:id` — зміна ПІБ/телефону/ролі/активності (Admin).
- `DELETE /api/employees/:id` — деактивація акаунта (Admin).

### Замовлення та каса
- `POST /api/orders` — створення замовлення (усі ролі). Валідує доступність інгредієнтів за рецептом, списує склад у транзакції, додає OrderDetail, підсумовує total.
- `GET /api/orders` — останні 25 замовлень: для Admin — всі, для Barista — лише власні.
- `PATCH /api/orders/:id/status` — оновлення статусу (`Paid | Cancelled | Completed`); бариста може змінювати тільки свої замовлення.

### Звіти
- `GET /api/reports/sales?period=day|week|month` — підсумок продажів за період + список замовлень (Admin).

### Технічні деталі
- **Middleware:** `cors`, `express.json`, статична видача `frontend/dist`.
- **JWT заголовок:** `Authorization: Bearer <token>`.
- **Файл БД:** `data/coffee_shop.sqlite` (створюється автоматично).

## 7. Логіка інвентаризації та замовлень
- Перед створенням замовлення функція `canFulfill` агрегує потребу за всіма інгредієнтами, перевіряє наявність залишків.
- Оформлення замовлення відбувається в транзакції: створення Order → OrderDetail → списання запасів за рецептом.
- Інвентаризація записує різницю як запис Supply (може бути від'ємною або додатною), щоб зберегти історію.
- Списання (`writeoff`) також фіксується як Supply з від'ємною кількістю.
- Статус `Completed` додає мітку `completed_at` для обліку виконаних замовлень.

## 8. Фронтенд і UX
- **Фреймворк:** Vite + React.
- **Авторизація:** зберігання токена в `localStorage`, автоматичне підхоплення поточного користувача через `/api/me`.
- **Бариста:** каталог продуктів, фільтрація, кошик з підрахунком total, вибір способу оплати, створення замовлення, підтвердження виконання власних чеків.
- **Адмін:**
  - Панель акаунтів: створення/активація/деактивація користувачів, вибір ролі.
  - Склад: перегляд запасів, підсвітка низьких, інвентаризація та списання.
  - Меню: додавання/архівація продуктів, категорії, перегляд неактивних позицій.
  - Рецептури: редагування складу продукту.
  - Звіти: виручка за день/тиждень/місяць і перелік замовлень.

## 9. Обслуговування та діагностика
- **Перезапуск із чистою БД:** видалити файл `data/coffee_shop.sqlite` і виконати `npm start` (створиться наново з демо-даними).
- **Перевірка логів:** сервер логірує порт під час старту, детальні помилки повертаються в JSON.
- **Зміна секрету JWT:** встановіть `APP_SECRET` і перезапустіть сервер (старі токени стануть невалідними).

## 10. Відповідність вимогам ролей
- **Admin:** управління акаунтами, інгредієнтами (інвентаризація, списання, рецепти), меню та категоріями, перегляд продажів.
- **Barista:** створення замовлення, підтвердження виконання (оновлення статусу), перегляд доступних активних продуктів.
